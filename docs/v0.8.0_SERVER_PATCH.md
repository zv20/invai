# v0.8.0 Server.js Integration Guide

This document outlines the changes needed to integrate Phase 1 features into server.js.

## Required Changes

### 1. Add Activity Logger Import (Line ~10)

```javascript
const ActivityLogger = require('./lib/activity-logger');
```

### 2. Initialize Activity Logger (After DB Connection, Line ~75)

```javascript
let activityLogger;

// In database connection callback:
db = new sqlite3.Database('./inventory.db', async (err) => {
  if (err) {
    console.error('Error opening database:', err);
    process.exit(1);
  } else {
    console.log('Connected to SQLite database');
    activityLogger = new ActivityLogger(db);  // ADD THIS LINE
    await initializeDatabase();
  }
});
```

### 3. Add New API Endpoints (Before `app.listen()`)

```javascript
// ========== v0.8.0: ACTIVITY LOG API ==========

app.get('/api/activity-log', async (req, res) => {
  try {
    const limit = parseInt(req.query.limit) || 50;
    const activities = await activityLogger.getRecent(limit);
    res.json(activities);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

app.get('/api/activity-log/:entityType/:entityId', async (req, res) => {
  try {
    const { entityType, entityId } = req.params;
    const activities = await activityLogger.getForEntity(entityType, entityId);
    res.json(activities);
  } catch (error) {
    res.status(500).json({ error: error.message });
  }
});

// ========== v0.8.0: REORDER ALERTS API ==========

app.get('/api/alerts/reorder-needed', (req, res) => {
  db.all(`
    SELECT 
      p.id as product_id, 
      p.name as product_name, 
      p.reorder_point,
      COALESCE(SUM(ib.total_quantity), 0) as current_stock
    FROM products p
    LEFT JOIN inventory_batches ib ON p.id = ib.product_id
    WHERE p.reorder_point > 0
    GROUP BY p.id
    HAVING current_stock < p.reorder_point
    ORDER BY current_stock ASC
  `, [], (err, rows) => {
    if (err) return res.status(500).json({ error: err.message });
    res.json(rows || []);
  });
});

app.put('/api/products/:id/reorder-point', (req, res) => {
  const { reorder_point, max_stock } = req.body;
  
  db.run(
    'UPDATE products SET reorder_point = ?, max_stock = ? WHERE id = ?',
    [reorder_point || 0, max_stock || 0, req.params.id],
    function(err) {
      if (err) return res.status(500).json({ error: err.message });
      if (this.changes === 0) return res.status(404).json({ error: 'Product not found' });
      
      // Log activity
      db.get('SELECT name FROM products WHERE id = ?', [req.params.id], (err, product) => {
        if (product && activityLogger) {
          activityLogger.log('update', 'product', req.params.id, product.name, {
            description: `Updated reorder point to ${reorder_point}`,
            newValue: { reorder_point, max_stock }
          }).catch(console.error);
        }
      });
      
      res.json({ message: 'Reorder point updated successfully' });
    }
  );
});

app.post('/api/products/:id/favorite', (req, res) => {
  db.run(
    'UPDATE products SET is_favorite = NOT is_favorite WHERE id = ?',
    [req.params.id],
    function(err) {
      if (err) return res.status(500).json({ error: err.message });
      if (this.changes === 0) return res.status(404).json({ error: 'Product not found' });
      
      db.get('SELECT is_favorite, name FROM products WHERE id = ?', [req.params.id], (err, product) => {
        if (product) {
          const action = product.is_favorite ? 'Favorited' : 'Unfavorited';
          if (activityLogger) {
            activityLogger.log('update', 'product', req.params.id, product.name, {
              description: `${action} product`
            }).catch(console.error);
          }
          res.json({ is_favorite: product.is_favorite });
        }
      });
    }
  );
});
```

### 4. Add Activity Logging to Existing Endpoints

#### POST /api/products (After line ~1200)

In the success callback, add:

```javascript
function(err) {
  if (err) {
    // ... existing error handling
  } else {
    // Log activity
    if (activityLogger) {
      activityLogger.log('create', 'product', this.lastID, name, {
        newValue: { name, barcode, brand, supplier_id, category_id }
      }).catch(console.error);
    }
    res.json({ id: this.lastID, message: 'Product added successfully' });
  }
}
```

#### PUT /api/products/:id (After line ~1220)

```javascript
function(err) {
  if (err) res.status(500).json({ error: err.message });
  else if (this.changes === 0) res.status(404).json({ error: 'Product not found' });
  else {
    // Log activity
    if (activityLogger) {
      activityLogger.log('update', 'product', req.params.id, name).catch(console.error);
    }
    res.json({ message: 'Product updated successfully' });
  }
}
```

#### DELETE /api/products/:id (After line ~1240)

Before the delete operation:

```javascript
app.delete('/api/products/:id', (req, res) => {
  // Get product name first for logging
  db.get('SELECT name FROM products WHERE id = ?', [req.params.id], (err, product) => {
    if (product && activityLogger) {
      activityLogger.log('delete', 'product', req.params.id, product.name).catch(console.error);
    }
    
    // Then delete
    db.run('DELETE FROM products WHERE id = ?', [req.params.id], function(err) {
      if (err) res.status(500).json({ error: err.message });
      else if (this.changes === 0) res.status(404).json({ error: 'Product not found' });
      else res.json({ message: 'Product deleted successfully' });
    });
  });
});
```

#### POST /api/inventory/batches (After line ~1350)

```javascript
function(err) {
  if (err) res.status(500).json({ error: err.message });
  else {
    // Log activity
    db.get('SELECT name FROM products WHERE id = ?', [product_id], (err, product) => {
      if (product && activityLogger) {
        activityLogger.log('create', 'batch', this.lastID, `Batch for ${product.name}`, {
          newValue: { case_quantity, total_quantity, expiry_date }
        }).catch(console.error);
      }
    });
    res.json({ id: this.lastID, total_quantity: totalQuantity, message: 'Batch added successfully' });
  }
}
```

#### PUT /api/inventory/batches/:id

```javascript
function(err) {
  if (err) res.status(500).json({ error: err.message });
  else if (this.changes === 0) res.status(404).json({ error: 'Batch not found' });
  else {
    if (activityLogger) {
      activityLogger.log('update', 'batch', req.params.id, 'Batch').catch(console.error);
    }
    res.json({ message: 'Batch updated successfully' });
  }
}
```

#### DELETE /api/inventory/batches/:id

```javascript
app.delete('/api/inventory/batches/:id', (req, res) => {
  if (activityLogger) {
    activityLogger.log('delete', 'batch', req.params.id, 'Batch').catch(console.error);
  }
  
  db.run('DELETE FROM inventory_batches WHERE id = ?', [req.params.id], function(err) {
    if (err) res.status(500).json({ error: err.message });
    else if (this.changes === 0) res.status(404).json({ error: 'Batch not found' });
    else res.json({ message: 'Batch deleted successfully' });
  });
});
```

#### Similar patterns for Categories and Suppliers

Add logging to:
- POST /api/categories
- PUT /api/categories/:id
- DELETE /api/categories/:id
- POST /api/suppliers
- PUT /api/suppliers/:id
- DELETE /api/suppliers/:id

### 5. Update Console Log on Server Start (Last line)

Change version reference:

```javascript
console.log(`Grocery Inventory Management v${VERSION}`);
console.log('ðŸ“Š v0.8.0: Activity logging & reorder points enabled');
```

## Testing

After applying these changes:

1. **Migration**: Migration 007 will run automatically on server restart
2. **Activity Log**: Test by creating/updating/deleting products
3. **Reorder Alerts**: Set reorder points on products and verify alerts appear
4. **API Endpoints**: Test new endpoints:
   - GET /api/activity-log
   - GET /api/activity-log/product/123
   - GET /api/alerts/reorder-needed
   - PUT /api/products/123/reorder-point

## Rollback

If issues occur:
1. Restore previous server.js from git
2. Run migration rollback if needed
3. Check logs for errors
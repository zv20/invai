// ========== SYSTEM UPDATE API (Add this after line 545, after /api/settings/switch-channel) ==========

app.post('/api/system/update', async (req, res) => {
  try {
    console.log('ðŸ“¥ Triggering system update via API...');
    
    // Create backup before update
    const backup = await createBackup('pre_update');
    console.log(`Backup created: ${backup.filename}`);
    
    // Run update script
    const updateScript = path.join(__dirname, 'update.sh');
    
    if (!fs.existsSync(updateScript)) {
      return res.status(500).json({ 
        error: 'Update script not found',
        hint: 'update.sh file is missing from the application directory'
      });
    }
    
    // Make script executable
    execSync(`chmod +x "${updateScript}"`, { cwd: __dirname });
    
    // Run update script with SKIP_PROMPT=true for non-interactive mode
    console.log('Running update script...');
    const output = execSync(`SKIP_PROMPT=true bash "${updateScript}"`, {
      cwd: __dirname,
      encoding: 'utf8',
      env: { ...process.env, SKIP_PROMPT: 'true' }
    });
    
    console.log('Update script output:', output);
    
    res.json({
      message: 'Update completed successfully',
      backupFile: backup.filename,
      output: output,
      restartRequired: true
    });
    
  } catch (error) {
    console.error('Update error:', error);
    res.status(500).json({
      error: 'Update failed: ' + error.message,
      hint: 'Check server logs for details. You can manually run: ./update.sh'
    });
  }
});
